<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>Choisir une adresse</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
            crossorigin=""
    />
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        .leaflet-control-attribution {
            font-size: 10px;
        }
    </style>
</head>
<body>
<div id="map"></div>

<script
        src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""
></script>
<script>
    // Centre par défaut (Tunisie approximatif)
    var map = L.map('map').setView([36.8065, 10.1815], 7);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    var marker = null;

    function setMarker(lat, lng) {
        if (marker) {
            marker.setLatLng([lat, lng]);
        } else {
            marker = L.marker([lat, lng]).addTo(map);
        }
    }

    function buildShortAddress(data, lat, lng) {
        if (!data || !data.address) {
            return data && data.display_name
                ? data.display_name
                : (lat.toFixed(5) + ', ' + lng.toFixed(5));
        }

        var a = data.address;
        var parts = [];

        if (a.house_number && a.road) {
            parts.push(a.house_number + " " + a.road);
        } else if (a.road) {
            parts.push(a.road);
        } else if (a.suburb) {
            parts.push(a.suburb);
        }

        var city = a.city || a.town || a.village || a.municipality || a.county;
        if (city) {
            parts.push(city);
        }

        if (a.country) {
            parts.push(a.country);
        }

        if (parts.length === 0 && data.display_name) {
            return data.display_name;
        }

        return parts.join(", ");
    }

    function reverseGeocode(lat, lng) {
        var url = 'https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=' +
            encodeURIComponent(lat) + '&lon=' + encodeURIComponent(lng) +
            '&addressdetails=1';

        // Note: on ne force pas le header User-Agent ici (interdit côté navigateur/WebView).
        fetch(url)
            .then(function (response) { return response.json(); })
            .then(function (data) {
                var shortName = buildShortAddress(data, lat, lng);
                if (marker) {
                    marker.bindPopup(shortName).openPopup();
                }
                if (window.app && typeof window.app.onLocationSelected === 'function') {
                    window.app.onLocationSelected(lat, lng, shortName);
                }
            })
            .catch(function (err) {
                console.error(err);
                if (window.app && typeof window.app.onLocationSelected === 'function') {
                    window.app.onLocationSelected(lat, lng, lat.toFixed(5) + ', ' + lng.toFixed(5));
                }
            });
    }

    map.on('click', function (e) {
        var lat = e.latlng.lat;
        var lng = e.latlng.lng;
        setMarker(lat, lng);
        reverseGeocode(lat, lng);
    });
</script>
</body>
</html>

